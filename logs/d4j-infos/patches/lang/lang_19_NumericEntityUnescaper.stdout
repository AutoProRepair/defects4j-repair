38c38,40
<         if(input.charAt(index) == '&' && index < (input.length() - 1) && input.charAt(index + 1) == '#') {
---
>         int seqEnd = input.length();
>         // Uses -2 to ensure there is something after the &#
>         if(input.charAt(index) == '&' && index < seqEnd - 2 && input.charAt(index + 1) == '#') {
45a48,52
> 
>                 // Check there's more than just an x after the &#
>                 if(start == seqEnd) {
>                     return 0;
>                 }
49c56,60
<             while(input.charAt(end) != ';') {
---
>             // Note that this supports character codes without a ; on the end
>             while(end < seqEnd && ( (input.charAt(end) >= '0' && input.charAt(end) <= '9') ||
>                                     (input.charAt(end) >= 'a' && input.charAt(end) <= 'f') ||
>                                     (input.charAt(end) >= 'A' && input.charAt(end) <= 'F') ) )
>             {
60a72
>             System.err.println("FAIL: " + input.subSequence(start, end) + "[" + start +"]["+ end +"]");
71c83,86
<             return 2 + (end - start) + (isHex ? 1 : 0) + 1;
---
> 
>             boolean semiNext = (end != seqEnd) && (input.charAt(end) == ';');
> 
>             return 2 + (end - start) + (isHex ? 1 : 0) + (semiNext ? 1 : 0);
