#!/bin/bash

cd ~/defects4j-nopol/logs/nopol-ranking/chart

echo '# Chart - Nopol ranking' > README.md
echo "" >> README.md

for bug in `seq 1 26`
do
  echo "Chart ${bug} nopol ranking readme"
  #Cut log
  #line=`grep -m 1 -n "^\/\*" stdout/chart_${bug}.stdout | cut -f 1 -d :`
  #tail -n +$line stdout/chart_${bug}.stdout > chart_${bug}_tmp.stdout
  #mv chart_${bug}_tmp.stdout stdout/chart_${bug}.stdout

  #Add time at the end log
  #cat stderr/chart_${bug}.stderr | tail -4 >> stdout/chart_${bug}.stdout
  #echo "" >> stdout/chart_${bug}.stdout

  echo "## Bug $bug" >> README.md
  echo "" >> README.md
  modifiedSources=`grep -e '->' ~/defects4j-nopol/logs/d4j-infos/patches/chart/chart_$bug.stdout`

  nbModifiedSources=`grep -e '->' ~/defects4j-nopol/logs/d4j-infos/patches/chart/chart_$bug.stdout | wc -l`
  echo "- Nb. modified sources: $nbModifiedSources" >> README.md
  echo "" >> README.md

  statementStart=`grep -m 1 -n "org" stdout/chart_${bug}.stdout | cut -f 1 -d :`

  if [[ ! $statementStart ]]; then
    statementStart=-1
  fi

  for index in `seq 1 $nbModifiedSources`
  do
    modifiedSource=`grep -e '->' ~/defects4j-nopol/logs/d4j-infos/patches/chart/chart_$bug.stdout | sed -n ${index}p`

    sourceName=`echo $modifiedSource | cut -f 2 -d '>' | cut -f 1 -d : | cut -f 1 -d . | tr / .`

    modifiedLines=`echo $modifiedSource | cut -f 2 -d :`

    echo "### $sourceName" >> README.md
    echo "" >> README.md

    className=`echo $sourceName | tr . ' ' | awk '{print $NF}'`
    echo '```' >> README.md
    cat ~/defects4j-nopol/logs/d4j-infos/patches/chart/chart_${bug}_${className}.stdout >> README.md
    echo '```' >> README.md
    deleted=`cat ~/defects4j-nopol/logs/d4j-infos/patches/chart/chart_${bug}_${className}.stdout | grep '<' | wc -l`
    added=`cat ~/defects4j-nopol/logs/d4j-infos/patches/chart/chart_${bug}_${className}.stdout | grep '>' | wc -l`
    echo "" >> README.md
    echo "- Deleted lines: $deleted<br />" >> README.md
    echo "- Added lines: $added<br />" >> README.md
    difference=0
    let "difference=added-deleted"
    echo "- Diff added/deleted: $difference" >> README.md
    echo "" >> README.md

    echo '| Line | Nopol log | Rank |' >> README.md
    echo '|------|-----------|------|' >> README.md

    undetectedLines=0
    undetectedLinesNumber=" "
    for line in $modifiedLines
    do
      unset rank
      unset nopolLine
      unset nopolLineNumber

      nopolLine=`grep -m 1 $sourceName:$line stdout/chart_$bug.stdout`

      nopolLineNumber=`grep -m 1 -n "$nopolLine" stdout/chart_$bug.stdout | cut -f 1 -d :`

      if [[ $nopolLineNumber ]]; then
        let "rank=($nopolLineNumber-$statementStart)+1"
      fi

      if [[ $nopolLine ]]; then
        echo "| $line | $nopolLine | $rank |" >> README.md
      else
        let "undetectedLines++"
        undetectedLinesNumber="$undetectedLinesNumber$line "
      fi

    done

    echo "" >> README.md

    if [[ $undetectedLines == 0 ]]; then
      echo "- Nb. undetected lines: $undetectedLines/$(echo $modifiedLines | wc -w)" >> README.md
    else
      echo "- Nb. undetected lines: $undetectedLines/$(echo $modifiedLines | wc -w) ($undetectedLinesNumber)" >> README.md
    fi

    echo "" >> README.md
  done

done

echo 'Done.'
