#!/bin/bash

export PATH="~/defects4j/framework/bin:$PATH"

cd ~/defects4j-nopol/logs/d4j-tests/math/

echo '# Math - Defects4j tests' > README.md
echo '| #Bug | Nb. tests run | Nb. failures | Nb. errors | Exec. time |' >> README.md
echo '|------|---------------|--------------|------------|------------|' >> README.md

for bug in `seq 1 106`
do
  echo "Starting tests Math ${bug} ..."

  exec 6<&1
  #exec 7<&2

  exec 1> ~/defects4j-nopol/logs/d4j-tests/math/math_${bug}.stdout
  #exec 2> ~/defects4j-nopol/logs/d4j-tests/math/math_${bug}.stderr

  defects4j checkout -p Math -v ${bug}b -w /tmp/math_${bug}

  cd /tmp/math_${bug}/
  defects4j compile
  defects4j test
  cd /tmp/
  rm -rf math_${bug}/

  exec 1<&6 6<&-
  #exec 2<&7 7<&-

  cd ~/defects4j-nopol/logs/d4j-tests/math/
  
  grep "Tests run" math_${bug}.stdout > math_${bug}_grep.stdout
  cut -f 1 -d "," math_${bug}_grep.stdout > math_${bug}_cut_1.stdout
  cut -f 2 -d ":" math_${bug}_cut_1.stdout > math_${bug}_cut_2.stdout
  testsRun=`sum=0; while read num; do sum=$(($sum + $num)); done < math_${bug}_cut_2.stdout ; echo $sum`
  
  cut -f 2 -d "," math_${bug}_grep.stdout > math_${bug}_cut_1.stdout
  cut -f 2 -d ":" math_${bug}_cut_1.stdout > math_${bug}_cut_2.stdout
  failures=`sum=0; while read num; do sum=$(($sum + $num)); done < math_${bug}_cut_2.stdout ; echo $sum`  
  
  cut -f 3 -d "," math_${bug}_grep.stdout > math_${bug}_cut_1.stdout
  cut -f 2 -d ":" math_${bug}_cut_1.stdout > math_${bug}_cut_2.stdout
  errors=`sum=0; while read num; do sum=$(($sum + $num)); done < math_${bug}_cut_2.stdout ; echo $sum`

  echo "" >> math_${bug}.stdout
  echo "Total tests run: $testsRun" >> math_${bug}.stdout
  echo "Total failures: $failures" >> math_${bug}.stdout
  echo "Total errors: $errors" >> math_${bug}.stdout

  rm math_${bug}_grep.stdout
  rm math_${bug}_cut_1.stdout
  rm math_${bug}_cut_2.stdout
  
  testsTime=`grep 'Total time:' math_${bug}.stdout | tail -1 | cut -f 2 -d ':'`
  
  echo "| ${bug} | ${testsRun} | ${failures} | ${errors} | ${testsTime} |" >> README.md

done

echo 'Done.'

